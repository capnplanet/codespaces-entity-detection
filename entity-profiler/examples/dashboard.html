<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Entity Profiler Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #0b1220; color: #e7ecf5; }
    h1 { margin-bottom: 8px; }
    .controls { margin-bottom: 12px; }
    input { padding: 6px; margin-right: 6px; }
    button { padding: 6px 10px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #2a3550; padding: 6px; font-size: 13px; }
    th { background: #1c2740; }
    tr:nth-child(even) { background: #11182a; }
    .severity-info { color: #8ab4f8; }
    .severity-warning { color: #f2c14e; }
    .severity-critical { color: #f47373; }
  </style>
</head>
<body>
  <h1>Entity Profiler Dashboard</h1>
  <div class="controls">
    <label>API URL <input id="apiUrl" size="32" value="http://localhost:8000" /></label>
    <label>Bearer Token <input id="token" size="28" placeholder="optional" /></label>
    <label>API Key <input id="apiKey" size="20" placeholder="optional" /></label>
    <label>Severity
      <select id="severity">
        <option value="">all</option>
        <option value="critical">critical</option>
        <option value="warning">warning</option>
        <option value="info">info</option>
      </select>
    </label>
    <label>Device <input id="device" size="10" placeholder="device-id" /></label>
    <label>Entity <input id="entity" size="10" placeholder="entity-id" /></label>
    <button onclick="refreshAll()">Refresh</button>
  </div>
  <div id="status"></div>
  <h3>Health Events</h3>
  <table id="healthTable">
    <thead><tr><th>Time</th><th>Entity</th><th>Device</th><th>Type</th><th>Severity</th><th>Status</th><th>Description</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Safety Events</h3>
  <table id="safetyTable">
    <thead><tr><th>Time</th><th>Entity</th><th>Device</th><th>Type</th><th>Severity</th><th>Status</th><th>Description</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
  <script>
    function headers() {
      const h = { 'Accept': 'application/json' };
      const t = document.getElementById('token').value.trim();
      const k = document.getElementById('apiKey').value.trim();
      if (t) h['Authorization'] = 'Bearer ' + t;
      if (k) h['X-Api-Key'] = k;
      return h;
    }
    function fmt(ts) {
      const d = new Date(ts * 1000);
      return d.toISOString();
    }
    function matchesFilters(ev) {
      const sev = document.getElementById('severity').value;
      const dev = document.getElementById('device').value.trim();
      const ent = document.getElementById('entity').value.trim();
      if (sev && ev.severity !== sev) return false;
      if (dev && ev.device_id !== dev) return false;
      if (ent && ev.entity_id !== ent) return false;
      return true;
    }

    async function ack(eventId, status) {
      const api = document.getElementById('apiUrl').value.replace(/\/$/, '');
      const headers = { 'Content-Type': 'application/json' };
      const t = document.getElementById('token').value.trim();
      const k = document.getElementById('apiKey').value.trim();
      if (t) headers['Authorization'] = 'Bearer ' + t;
      if (k) headers['X-Api-Key'] = k;
      await fetch(api + '/events/ack', {
        method: 'POST',
        headers,
        body: JSON.stringify({ event_id: eventId, status })
      }).catch(() => {});
    }

    function render(tableId, events) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = '';
      events.slice().reverse().forEach(ev => {
        if (!matchesFilters(ev)) return;
        const tr = document.createElement('tr');
        const sevClass = 'severity-' + (ev.severity || 'info');
        tr.innerHTML = `<td>${fmt(ev.timestamp)}</td><td>${ev.entity_id||''}</td><td>${ev.device_id||''}</td><td>${ev.type||''}</td><td class="${sevClass}">${ev.severity||''}</td><td>${ev.status||'open'}</td><td>${ev.description||''}</td><td><button onclick="ack('${ev.event_id}','acknowledged')">Ack</button><button onclick="ack('${ev.event_id}','resolved')">Resolve</button></td>`;
        tbody.appendChild(tr);
      });
    }
    async function fetchEvents(path) {
      const api = document.getElementById('apiUrl').value.replace(/\/$/, '');
      const res = await fetch(api + path, { headers: headers() });
      if (!res.ok) throw new Error(`${path} ${res.status}`);
      return res.json();
    }
    let es;

    function startStream() {
      const statusEl = document.getElementById('status');
      const api = document.getElementById('apiUrl').value.replace(/\/$/, '');
      const t = encodeURIComponent(document.getElementById('token').value.trim());
      const k = encodeURIComponent(document.getElementById('apiKey').value.trim());
      const url = `${api}/events/stream?token=${t}&api_key=${k}`;
      if (es) es.close();
      try {
        es = new EventSource(url);
        es.onmessage = (evt) => {
          try {
            const ev = JSON.parse(evt.data);
            if (ev.category === 'health') {
              render('healthTable', (window._health = (window._health || []).concat([ev])).slice(-100));
            } else if (ev.category === 'safety') {
              render('safetyTable', (window._safety = (window._safety || []).concat([ev])).slice(-100));
            }
            statusEl.textContent = 'Streaming';
          } catch (e) {
            statusEl.textContent = 'Parse error';
          }
        };
        es.onerror = () => {
          statusEl.textContent = 'Stream error, falling back to polling';
          es.close();
          es = null;
          refreshAll();
          setInterval(refreshAll, 10000);
        };
      } catch (e) {
        statusEl.textContent = 'Stream setup failed, polling';
        refreshAll();
        setInterval(refreshAll, 10000);
      }
    }

    async function refreshAll() {
      const status = document.getElementById('status');
      status.textContent = 'Loading...';
      try {
        const [health, safety] = await Promise.all([
          fetchEvents('/health/events'),
          fetchEvents('/safety/events')
        ]);
        window._health = health || [];
        window._safety = safety || [];
        render('healthTable', window._health);
        render('safetyTable', window._safety);
        status.textContent = 'OK (polling)';
      } catch (e) {
        status.textContent = 'Error: ' + e.message;
      }
    }

    refreshAll();
    startStream();
  </script>
</body>
</html>
